{% extends "base.html" %}

{% block title %}Select Customer & Machine - Add Service Note{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white shadow-md rounded-[24px] p-8 mt-8">
  <h1 class="text-2xl font-bold text-black mb-6">Select Customer and Machine</h1>

  <form method="post" id="selectForm">
    {% csrf_token %}
    <input type="hidden" name="next" value="{% url 'service_notes' %}">

    <div class="relative"> <label for="customer" class="block text-sm font-medium text-gray-700 mb-2">Customer</label>
      <input type="text" id="customerInput" placeholder="Start typing a customer name..."
             class="w-full px-4 py-2 border border-gray-300 rounded-full mb-1 focus:outline-none focus:ring-2 focus:ring-yellow-500" autocomplete="off">

      <select name="customer_id" id="customerSelect" class="w-full absolute z-10 border border-gray-300 rounded-lg bg-white" size="5" style="display: none;">
        {% for customer in customers %}
        <option value="{{ customer.id }}">{{ customer.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mt-6"> <label for="machine" class="block text-sm font-medium text-gray-700 mb-2">Machine</label>
        <select name="machine_id" id="machineSelect" class="w-full px-4 py-2 border border-gray-300 rounded-full mb-6" disabled>
          <option value="">Select a customer first</option>
        </select>
    </div>

    <div class="flex justify-end mt-4">
      <button type="submit" id="continueButton" class="bg-yellow-500 hover:bg-yellow-600 text-black font-semibold px-6 py-3 rounded-full transition duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
        Continue
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const customerInput = document.getElementById("customerInput");
    const customerSelect = document.getElementById("customerSelect");
    const machineSelect = document.getElementById("machineSelect");
    const continueButton = document.getElementById("continueButton");
    
    const allCustomerOptions = Array.from(customerSelect.options);

    // 1. Filter customer dropdown as user types
    customerInput.addEventListener("input", function() {
        const query = this.value.toLowerCase().trim();
        const filteredOptions = allCustomerOptions.filter(option => 
            option.text.toLowerCase().includes(query)
        );

        customerSelect.innerHTML = ''; 
        if (query.length > 0 && filteredOptions.length > 0) {
            filteredOptions.forEach(option => customerSelect.add(option));
            customerSelect.style.display = "block";
        } else {
            customerSelect.style.display = "none";
        }
    });

    // 2. Handle customer selection
    customerSelect.addEventListener("change", function() {
        const selectedOption = this.options[this.selectedIndex];
        if (!selectedOption) return;

        customerInput.value = selectedOption.text;
        customerSelect.style.display = "none";
        
        machineSelect.disabled = false;
        machineSelect.innerHTML = '<option value="">Loading machines...</option>';
        continueButton.disabled = true;

        fetch(`/api/machines/?customer_id=${selectedOption.value}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                machineSelect.innerHTML = ''; 
                if (data.length > 0) {
                    data.forEach(machine => {
                        const option = new Option(`${machine.name} (${machine.serial_number})`, machine.id);
                        machineSelect.add(option);
                    });
                    // FIX: Manually enable button since first item is now selected.
                    if (machineSelect.value) {
                        continueButton.disabled = false;
                    }
                } else {
                    machineSelect.innerHTML = '<option value="">No machines found</option>';
                    machineSelect.disabled = true;
                    continueButton.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error fetching machines:', error);
                machineSelect.innerHTML = '<option value="">Error loading machines</option>';
                machineSelect.disabled = true;
                continueButton.disabled = true;
            });
    });
    
    // 3. Enable Continue button only when a machine is MANUALLY changed
    machineSelect.addEventListener("change", function() {
        if (this.value) {
            continueButton.disabled = false;
        } else {
            continueButton.disabled = true;
        }
    });

    // 4. Hide customer dropdown if user clicks elsewhere on the page
    document.addEventListener("click", function(e) {
        if (e.target !== customerInput && e.target !== customerSelect) {
            customerSelect.style.display = "none";
        }
    });
});
</script>
{% endblock %}