{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="bg-white text-black min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-6">
    
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-black mb-4 md:mb-0">Invoice Management</h1>
      <a href="{% url 'invoice_create' %}" class="bg-yellow-500 text-black font-bold px-6 py-3 shadow-md rounded-full hover:bg-yellow-600 transition">
        Create New Invoice
      </a>
    </div>

    
    <div class="bg-white border border-gray-200 shadow-md p-6 rounded-[24px] mb-6">
      <form method="GET" id="filterForm">
        {% csrf_token %}
        <!-- Basic Search Row -->
        <div class="flex flex-wrap gap-4 mb-4">
          <input 
            type="text" 
            name="search" 
            value="{{ search_query }}" 
            placeholder="Search by invoice number, customer name, email..." 
            class="flex-1 min-w-[250px] px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500"
          >
          <button type="button" onclick="toggleFilters()" class="bg-blue-500 text-white px-4 py-2 shadow-md rounded-full hover:bg-blue-600 transition flex items-center gap-2" id="filterToggleBtn">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v4.172a1 1 0 01-.542.896l-2 1A1 1 0 0111 19.414v-5.172a1 1 0 00-.293-.707L4.293 7.121A1 1 0 014 6.414V4z"/>
            </svg>
            <span id="filterToggleText">Filter</span>
          </button>
          <button type="submit" class="bg-black text-white px-6 py-2 shadow-md rounded-full hover:bg-gray-800 transition">
            Search
          </button>
        </div>

        
        <div id="filtersPanel" class="hidden border-t pt-4 transition-all duration-300 ease-in-out">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Type</label>
              <select name="type" class="w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <option value="">All Types</option>
                <option value="BILL" {% if invoice_type == 'BILL' %}selected{% endif %}>Bill</option>
                <option value="QUOTATION" {% if invoice_type == 'QUOTATION' %}selected{% endif %}>Quotation</option>
              </select>
            </div>

           
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date From</label>
              <input 
                type="date" 
                name="date_from" 
                value="{{ date_from }}" 
                class="w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date To</label>
              <input 
                type="date" 
                name="date_to" 
                value="{{ date_to }}" 
                class="w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500"
              >
            </div>

            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Min Amount (₹)</label>
              <input 
                type="number" 
                step="0.01" 
                name="amount_min" 
                value="{{ amount_min }}" 
                placeholder="0.00"
                class="w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Max Amount (₹)</label>
              <input 
                type="number" 
                step="0.01" 
                name="amount_max" 
                value="{{ amount_max }}" 
                placeholder="999999.99"
                class="w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500"
              >
            </div>

            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Mailed Status</label>
              <select name="mailed_status" class="w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <option value="">All Status</option>
                <option value="true" {% if mailed_status == 'true' %}selected{% endif %}>Mailed</option>
                <option value="false" {% if mailed_status == 'false' %}selected{% endif %}>Not Mailed</option>
              </select>
            </div>

          </div>
        </div>
      </form>

        </div>
      </form>

      
      {% if search_query or invoice_type or date_from or date_to or amount_min or amount_max or mailed_status %}
      <div class="border-t pt-4 mt-4">
        <div class="flex flex-wrap gap-2">
          <span class="text-sm font-medium text-gray-700">Active Filters:</span>
          
          {% if search_query %}
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
            Search: "{{ search_query }}"
            <button type="button" onclick="removeFilter('search')" class="ml-2 text-yellow-600 hover:text-yellow-800">×</button>
          </span>
          {% endif %}
          
          {% if invoice_type %}
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            Type: {{ invoice_type }}
            <button type="button" onclick="removeFilter('type')" class="ml-2 text-blue-600 hover:text-blue-800">×</button>
          </span>
          {% endif %}
          
          {% if date_from %}
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
            From: {{ date_from }}
            <button type="button" onclick="removeFilter('date_from')" class="ml-2 text-green-600 hover:text-green-800">×</button>
          </span>
          {% endif %}
          
          {% if date_to %}
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
            To: {{ date_to }}
            <button type="button" onclick="removeFilter('date_to')" class="ml-2 text-green-600 hover:text-green-800">×</button>
          </span>
          {% endif %}
          
          {% if amount_min %}
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
            Min: ₹{{ amount_min }}
            <button type="button" onclick="removeFilter('amount_min')" class="ml-2 text-purple-600 hover:text-purple-800">×</button>
          </span>
          {% endif %}
          
          {% if amount_max %}
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
            Max: ₹{{ amount_max }}
            <button type="button" onclick="removeFilter('amount_max')" class="ml-2 text-purple-600 hover:text-purple-800">×</button>
          </span>
          {% endif %}
          
          {% if mailed_status %}
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
            Status: {% if mailed_status == 'true' %}Mailed{% else %}Not Mailed{% endif %}
            <button type="button" onclick="removeFilter('mailed_status')" class="ml-2 text-red-600 hover:text-red-800">×</button>
          </span>
          {% endif %}

           <button type="button" onclick="clearFilters()" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-600 text-white">
            Clear All
          </button>
        </div>
      </div>
      {% endif %}
    </div>

    
    {% if invoices.paginator.count > 0 %}
    <div class="mb-4 text-sm text-gray-600">
      Showing {{ invoices.start_index }} to {{ invoices.end_index }} of {{ invoices.paginator.count }} invoices
    </div>
    {% endif %}

    
    <div class="bg-white border border-gray-200 shadow-md p-4 rounded-[24px] hidden md:block">
      <h2 class="text-xl font-semibold text-black mb-4">All Invoices</h2>
      
      {% if invoices %}
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-200 rounded-[24px] overflow-hidden">
          <thead class="bg-yellow-500 text-black">
            <tr>
              <th class="px-4 py-2 text-center">Type</th>
              <th class="px-4 py-2 text-center">Invoice Number</th>
              <th class="px-4 py-2 text-center">Customer</th>
              <th class="px-4 py-2 text-center">Date</th>
              <th class="px-4 py-2 text-center">Total Amount</th>
              <th class="px-4 py-2 text-center">Status</th>
              <th class="px-4 py-2 text-center">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white">
            {% for invoice in invoices %}
            <tr class="border-t hover:bg-gray-100" onclick="window.location='{% url 'invoice_detail' invoice.pk %}'">
              <td class="px-4 py-2 text-center">
                <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full 
                  {% if invoice.invoice_type == 'BILL' %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                  {{ invoice.get_invoice_type_display }}
                </span>
              </td>
              <td class="px-4 py-2 font-medium text-center">{{ invoice.invoice_number }}</td>
              <td class="px-4 py-2 text-center">{{ invoice.customer.name }}</td>
              <td class="px-4 py-2 text-center">{{ invoice.date|date:"M d, Y" }}</td>
              <td class="px-4 py-2 text-center font-semibold">₹{{ invoice.total_amount }}</td>
              <td class="px-4 py-2 text-center">
                <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full 
                  {% if invoice.mailed %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                  {{ invoice.mailed|yesno:"Mailed,Not Mailed" }}
                </span>
                {% if invoice.invoice_type == 'BILL' %}
                {% if invoice.payment_status == 'PAID' %}
                  <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ml-1 bg-green-200 text-green-800">
                    Paid
                  </span>
                {% elif invoice.payment_status == 'PENDING' %}
                  <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ml-1 bg-yellow-200 text-yellow-800">
                    Pending
                  </span>
                {% elif invoice.payment_status == 'OVERDUE' %}
                  <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ml-1 bg-red-200 text-red-800">
                    Overdue
                  </span>
                {% endif %}
              {% endif %}
              </td>
              <td class="px-4 py-2 text-center">
                <div class="flex justify-center gap-2">
                  {% if invoice.invoice_type == 'BILL' and invoice.payment_status != 'PAID' %}
                  <a href="#" onclick="updatePaymentStatus({{ invoice.pk }}, event)" class="shadow-md bg-blue-500 text-white px-3 py-1 rounded-full text-sm hover:bg-blue-600 transition">
                      Mark Paid
                  </a>
                  {% endif %}
                  <a href="{% url 'download_invoice' invoice.pk %}" onclick="event.stopPropagation();" class="shadow-md bg-green-500 text-white px-3 py-1 rounded-full text-sm hover:bg-green-600 transition">
                      Download
                  </a>
                  <a href="{% url 'invoice_delete' invoice.pk %}?next={% url 'invoice_list' %}" onclick="event.stopPropagation();" class="shadow-md bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600 transition">
                      Delete
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                <div class="py-8">
                  <h3 class="text-gray-600 font-bold text-xl">No Invoices Found</h3>
                  <p class="text-gray-400 text-md">Try adjusting your filters or create a new invoice</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% else %}
      <div class="text-center py-8">
        <h3 class="text-gray-600 font-bold text-xl">No invoice found</h3>
        {% comment %} <p class="text-gray-400 text-md">Create your first invoice</p>
        <a href="{% url 'invoice_create' %}" class="inline-block mt-4 bg-yellow-500 text-black font-bold px-6 py-3 rounded-full hover:bg-yellow-600 transition">
          Create Invoice
        </a> {% endcomment %}
      </div>
      {% endif %}
    </div>

    
    <div class="bg-white border border-gray-200 shadow-md p-4 rounded-[24px] md:hidden">
      <h2 class="text-xl font-semibold text-black mb-4">All Invoices</h2>
      
      {% if invoices %}
      {% for invoice in invoices %}
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-start mb-2">
          <div>
            <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full 
              {% if invoice.invoice_type == 'BILL' %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}">
              {{ invoice.get_invoice_type_display }}
            </span>
            <h3 class="font-bold text-lg mt-1">{{ invoice.invoice_number }}</h3>
          </div>
          <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full 
            {% if invoice.mailed %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
            {{ invoice.mailed|yesno:"Mailed,Not Mailed" }}
          </span>
        </div>
        
        <div class="space-y-1 text-sm mb-3">
          <p><span class="font-semibold">Customer:</span> {{ invoice.customer.name }}</p>
          <p><span class="font-semibold">Date:</span> {{ invoice.date|date:"M d, Y" }}</p>
          <p><span class="font-semibold">Amount:</span> <span class="font-bold">₹{{ invoice.total_amount }}</span></p>
        </div>
        
        <div class="flex gap-2">
          <a href="{% url 'invoice_detail' invoice.pk %}" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded-full text-sm text-center hover:bg-blue-600 transition">
            View
          </a>
          <a href="{% url 'download_invoice' invoice.pk %}" class="flex-1 bg-green-500 text-white px-3 py-2 rounded-full text-sm text-center hover:bg-green-600 transition">
            Download
          </a>
         {% if not invoice.mailed %}
          <button class="flex-1 bg-yellow-500 text-black px-3 py-2 rounded-full text-sm hover:bg-yellow-600 transition" onclick="markAsMailed({{ invoice.pk }})">
            Mark Mailed
          </button>
          {% endif %} 
        </div>
      </div>
      {% empty %}
      <div class="text-center py-8">
        <h3 class="text-gray-600 font-bold text-xl">No Invoices Found</h3>
        <p class="text-gray-400 text-md">Try adjusting your filters or create a new invoice</p>
      </div>
      {% endfor %}

      {% else %}
      <div class="text-center py-8">
        <h3 class="text-gray-600 font-bold text-xl">Get Started</h3>
        <p class="text-gray-400 text-md">Create your first invoice</p>
        <a href="{% url 'invoice_create' %}" class="inline-block mt-4 bg-yellow-500 text-black font-bold px-6 py-3 rounded-full hover:bg-yellow-600 transition">
          Create Invoice
        </a>
      </div>
      {% endif %}
    </div>

    
    {% if is_paginated %}
    <div class="flex justify-center mt-6">
      <div class="flex gap-2">
        {% if invoices.has_previous %}
          <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% if request.GET.amount_min %}&amount_min={{ request.GET.amount_min }}{% endif %}{% if request.GET.amount_max %}&amount_max={{ request.GET.amount_max }}{% endif %}{% if request.GET.mailed_status %}&mailed_status={{ request.GET.mailed_status }}{% endif %}" class="px-3 py-2 bg-gray-200 rounded-full hover:bg-gray-300 transition">First</a>
          <a href="?page={{ invoices.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% if request.GET.amount_min %}&amount_min={{ request.GET.amount_min }}{% endif %}{% if request.GET.amount_max %}&amount_max={{ request.GET.amount_max }}{% endif %}{% if request.GET.mailed_status %}&mailed_status={{ request.GET.mailed_status }}{% endif %}" class="px-3 py-2 bg-gray-200 rounded-full hover:bg-gray-300 transition">Previous</a>
        {% endif %}
        
        <span class="px-3 py-2 bg-yellow-500 text-black font-bold rounded-full">
          {{ invoices.number }} of {{ invoices.paginator.num_pages }}
        </span>
        
        {% if invoices.has_next %}
          <a href="?page={{ invoices.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% if request.GET.amount_min %}&amount_min={{ request.GET.amount_min }}{% endif %}{% if request.GET.amount_max %}&amount_max={{ request.GET.amount_max }}{% endif %}{% if request.GET.mailed_status %}&mailed_status={{ request.GET.mailed_status }}{% endif %}" class="px-3 py-2 bg-gray-200 rounded-full hover:bg-gray-300 transition">Next</a>
          <a href="?page={{ invoices.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% if request.GET.amount_min %}&amount_min={{ request.GET.amount_min }}{% endif %}{% if request.GET.amount_max %}&amount_max={{ request.GET.amount_max }}{% endif %}{% if request.GET.mailed_status %}&mailed_status={{ request.GET.mailed_status }}{% endif %}" class="px-3 py-2 bg-gray-200 rounded-full hover:bg-gray-300 transition">Last</a>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </div>
</div>

<script>

function toggleFilters() {
  const filtersPanel = document.getElementById('filtersPanel');
  const toggleBtn = document.getElementById('filterToggleBtn');
  const toggleText = document.getElementById('filterToggleText');
  
  if (filtersPanel.classList.contains('hidden')) {
    filtersPanel.classList.remove('hidden');
    filtersPanel.classList.add('animate-slideDown');
    toggleBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    toggleBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
    toggleText.textContent = 'Hide';
  } else {
    filtersPanel.classList.add('hidden');
    filtersPanel.classList.remove('animate-slideDown');
    toggleBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    toggleBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
    toggleText.textContent = 'Filters';
  }
}


document.addEventListener('DOMContentLoaded', function() {
  const hasActiveFilters = {{ invoice_type|yesno:"true,false" }} || 
                          {{ date_from|yesno:"true,false" }} || 
                          {{ date_to|yesno:"true,false" }} || 
                          {{ amount_min|yesno:"true,false" }} || 
                          {{ amount_max|yesno:"true,false" }} || 
                          {{ mailed_status|yesno:"true,false" }};
  
  if (hasActiveFilters) {
    toggleFilters();
  }
  
  const form = document.getElementById('filterForm');
  const selects = form.querySelectorAll('select');
  const dateInputs = form.querySelectorAll('input[type="date"]');
  const numberInputs = form.querySelectorAll('input[type="number"]');
  
  
  selects.forEach(select => {
    select.addEventListener('change', function() {
      form.submit();
    });
  });
  
  
  dateInputs.forEach(input => {
    input.addEventListener('change', function() {
      form.submit();
    });
  });
  
 
  numberInputs.forEach(input => {
    let timeout;
    input.addEventListener('input', function() {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        form.submit();
      }, 1000); 
    });
  });
});


function clearFilters() {
  window.location.href = window.location.pathname;
}


function removeFilter(filterName) {
  const url = new URL(window.location.href);
  url.searchParams.delete(filterName);
  url.searchParams.delete('page'); // Reset to first page when removing filter
  window.location.href = url.toString();
}


function markAsMailed(invoiceId, event) {
  
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }
  
  if (confirm('Are you sure you want to mark this invoice as mailed?')) {
    fetch(`/invoices/${invoiceId}/mark-mailed/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
    });
  }
}


document.addEventListener('DOMContentLoaded', function() {
  const csrfToken = document.cookie.match(/csrftoken=([^;]+)/);
  if (csrfToken && !document.querySelector('[name=csrfmiddlewaretoken]')) {
    const tokenInput = document.createElement('input');
    tokenInput.type = 'hidden';
    tokenInput.name = 'csrfmiddlewaretoken';
    tokenInput.value = csrfToken[1];
    document.body.appendChild(tokenInput);
  }
});

function updatePaymentStatus(invoiceId, event) {
  
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }
  
  if (confirm("Mark this invoice as Paid?")) {
    fetch(`/invoices/${invoiceId}/update-payment-status/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
    });
  }
}
</script>

{% endblock %}